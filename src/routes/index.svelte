<script lang="ts">
	import { Input } from '@smui/textfield';
	import Paper from '@smui/paper';
	import Fab from '@smui/fab';
	import { Icon } from '@smui/common';
	import SplitioIcon from '$lib/SplitioIcon.svelte';
	import Button, { Label } from '@smui/button';
	import CreateGroupDialog from '$lib/CreateGroupDialog.svelte';
	import { onMount } from 'svelte';
	import { getSEA, initAppDB } from '$lib/_modules/initGun';
	import { redirectToAbout, redirectToGroup } from '$lib/_modules/utils';
	import { putSecure } from '$lib/_modules/secure';
	import IconButton from '@smui/icon-button/IconButton.svelte';
	import type { IGunStaticSEA } from 'gun/types/static/sea';
	import CircularProgress from '@smui/circular-progress';

	let groupValue = '';
	let openCreateGroupDialog: boolean = false;
	let hideLoadingSpinner: boolean = true;

	function handleKeyDown(event: CustomEvent | KeyboardEvent) {
		event = event as KeyboardEvent;
		if (event.key === 'Enter') {
			redirectToGroup(groupValue, window.location.hash);
		}
	}

	let appDB: any = undefined;
	let SEA: IGunStaticSEA | undefined = undefined;

	onMount(() => {
		appDB = initAppDB();
		SEA = getSEA();
	});

	const createGroup = async (groupName: string) => {
		hideLoadingSpinner = false;
		const result = appDB.set({ expenses: {}, members: {}, groupInfo: {} });
		const secretKey = '#' + (await SEA.pair()).priv;
		const nodeid = result._.has;
		console.log(result, result._.has);
		let infoNode = appDB.get(nodeid).get('groupInfo');
		putSecure(infoNode, { name: groupName }, secretKey, (ack) => {
			if (!ack.err) {
				redirectToGroup(nodeid, secretKey);
			} else {
				alert('error creating group :( please try again. code: ' + ack.err);
				hideLoadingSpinner = true;
			}
		});
	};
</script>

<svelte:head>
	<title>splitio | home</title>
</svelte:head>

<div class="homepage-container">
	<div>
		<SplitioIcon />
	</div>
	<IconButton
		on:click={() => redirectToAbout()}
		class="material-icons info-btn"
		aria-label="Information">info</IconButton
	>
	<div class="group-text-container">
		<Button
			style="border-radius: 17px; margin: 1.5rem"
			variant="raised"
			color="secondary"
			on:click={() => (openCreateGroupDialog = true)}
		>
			<Icon class="material-icons">add</Icon>
			<Label>create group</Label>
		</Button>
		<div class="mdc-typography--body1">or paste your group id here:</div>
		<Paper class="solo-paper" elevation={4}>
			<Icon class="material-icons">group</Icon>
			<Input
				bind:value={groupValue}
				on:keydown={handleKeyDown}
				placeholder="Group ID"
				class="solo-input"
			/>
		</Paper>
		<Fab
			on:click={() => redirectToGroup(groupValue, window.location.hash)}
			exited={groupValue === ''}
			color="secondary"
			class="solo-fab"
		>
			<Icon class="material-icons">arrow_forward</Icon>
		</Fab>
	</div>
</div>


<!-- Loading overlay -->
<div class="black-overlay" hidden={hideLoadingSpinner}>
	<div class="fixed-center">
		<CircularProgress
			style="height: 100px; width: 100px;"
			indeterminate
			class="create-group-loading"
		/>
	</div>
</div>

<CreateGroupDialog bind:openDialog={openCreateGroupDialog} addCallback={createGroup} />

<style>
	.fixed-center {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
	}
	.black-overlay {
		height: 100%;
		width: 100%;
		background: rgba(0, 0, 0, 0.6);
		position: fixed;
		top: 0;
	}
	.homepage-container {
		min-height: 100vh;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

	.group-text-container {
		/* padding: 0px 1px; */
		display: flex;
		justify-content: center;
		align-items: center;
		flex-direction: column;
	}

	* :global(.solo-paper) {
		display: flex;
		align-items: center;
		flex-grow: 1;
		max-width: 600px;
		margin: 1rem 12px;
		padding: 0 12px;
		height: 48px;
	}
	* :global(.solo-paper > *) {
		display: inline-block;
		margin: 0 12px;
	}
	* :global(.solo-input) {
		flex-grow: 1;
		color: var(--mdc-theme-on-surface, gray);
	}
	* :global(.solo-input::placeholder) {
		color: var(--mdc-theme-on-surface, gray);
		opacity: 0.6;
	}
	* :global(.solo-fab) {
		flex-shrink: 0;
		margin-top: 0rem;
	}

	* :global(.info-btn) {
		position: absolute;
		top: 1rem;
		right: 1rem;
	}
</style>
